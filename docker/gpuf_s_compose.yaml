version: "3.8"

name: GPUFabric

services:
  # ==================== Infrastructure Services ====================
  
  postgres:
    image: postgres:15-alpine
    container_name: gpuf-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: GPUFabric
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/db.sql:/docker-entrypoint-initdb.d/db.sql:ro
    networks:
      - frpx-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: gpuf-redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - frpx-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  zookeeper:
    image: confluentinc/cp-zookeeper:7.0.1
    container_name: gpuf-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_DATA_DIR: /var/lib/zookeeper/data
      ZOOKEEPER_DATA_LOG_DIR: /var/lib/zookeeper/log
    ports:
      - "2181:2181"
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_logs:/var/lib/zookeeper/log
    networks:
      - frpx-net
    restart: unless-stopped

  kafka:
    image: confluentinc/cp-kafka:7.0.1
    container_name: gpuf-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "29092:29092"
    volumes:
      - kafka_data:/var/lib/kafka/data
      - kafka_logs:/var/log/kafka
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_HEAP_OPTS: "-Xmx2G -Xms2G"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://:29092,PLAINTEXT_HOST://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_SOCKET_REQUEST_MAX_BYTES: 104857600
      KAFKA_SOCKET_SEND_BUFFER_BYTES: 1048576
      KAFKA_SOCKET_RECEIVE_BUFFER_BYTES: 1048576
      KAFKA_MESSAGE_MAX_BYTES: 104857600
    networks:
      - frpx-net
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  kafka-init:
    image: confluentinc/cp-kafka:7.0.1
    container_name: gpuf-kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - frpx-net
    entrypoint: []
    command: >
      bash -c '
        echo "Waiting for Kafka to be ready...";
        sleep 5;
        
        echo "Creating topics...";
        
        kafka-topics --create \
          --if-not-exists \
          --topic client-heartbeats \
          --bootstrap-server kafka:29092 \
          --partitions 3 \
          --replication-factor 1 \
          --config retention.ms=604800000 \
          --config segment.bytes=104857600;
        
        kafka-topics --create \
          --if-not-exists \
          --topic request-message \
          --bootstrap-server kafka:29092 \
          --partitions 3 \
          --replication-factor 1 \
          --config retention.ms=604800000;
        
        echo "Topics created successfully!";
        
        kafka-topics --list --bootstrap-server kafka:29092;
        
        echo "Kafka initialization complete.";
      '
    restart: "no"
    labels:
      - "com.docker.compose.oneoff=True"  # Auto-remove after exit

  # ==================== Application Services ====================

  gpuf-s:
    image: GPUFabric/gpuf-s:latest
    container_name: gpuf-s
    build:
      context: ..
      dockerfile: docker/Dockerfile.runtime
      args:
        BIN: gpuf-s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    ports:
      - "17000:17000"  # Control port
      - "17001:17001"  # Proxy port
      - "18080:18080"  # Public port
    volumes:
      - ./cert.pem:/app/cert.pem:ro
      - ./key.pem:/app/key.pem:ro
      # - ../config:/app/config  # Currently unused, all configs via CLI args
    environment:
      DATABASE_URL: postgres://postgres:password@postgres:5432/GPUFabric
      REDIS_URL: redis://redis:6379
      RUST_LOG: gpuf-s=info
    command: >
      --control-port 17000
      --proxy-port 17001
      --public-port 18080
      --database-url postgres://postgres:password@postgres:5432/GPUFabric
      --redis-url redis://redis:6379
      --bootstrap-server kafka:29092
      --api-key abc123
      --proxy-cert-chain-path /app/cert.pem
      --proxy-private-key-path /app/key.pem
    networks:
      - frpx-net
    healthcheck:
      test: ["CMD", "pgrep", "-x", "gpuf-s"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  api-server:
    image: GPUFabric/api_server:latest
    container_name: api-server
    build:
      context: ..
      dockerfile: docker/Dockerfile.runtime
      args:
        BIN: api_server
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "18081:18081"  # API port
    environment:
      DATABASE_URL: postgres://postgres:password@postgres:5432/GPUFabric
      REDIS_URL: redis://redis:6379
      RUST_LOG: api_server=info
    command: >
      --port 18081
      --database-url postgres://postgres:password@postgres:5432/GPUFabric
      --redis-url redis://redis:6379
    networks:
      - frpx-net
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:18081/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  heartbeat-consumer:
    image: GPUFabric/heartbeat_consumer:latest
    container_name: heartbeat-consumer
    build:
      context: ..
      dockerfile: docker/Dockerfile.runtime
      args:
        BIN: heartbeat_consumer
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    environment:
      DATABASE_URL: postgres://postgres:password@postgres:5432/GPUFabric
      RUST_LOG: heartbeat_consumer=info
    command: >
      --batch-size 100
      --batch-timeout 5
      --database-url postgres://postgres:password@postgres:5432/GPUFabric
      --bootstrap-server kafka:29092
    networks:
      - frpx-net
    healthcheck:
      test: ["CMD", "pgrep", "-f", "heartbeat_consumer"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

# ==================== Networks ====================
networks:
  frpx-net:
    driver: bridge
    name: frpx-network

# ==================== Volumes ====================
volumes:
  postgres_data:
    name: frpx-postgres-data
  redis_data:
    name: frpx-redis-data
  zookeeper_data:
    name: frpx-zookeeper-data
  zookeeper_logs:
    name: frpx-zookeeper-logs
  kafka_data:
    name: frpx-kafka-data
  kafka_logs:
    name: frpx-kafka-logs